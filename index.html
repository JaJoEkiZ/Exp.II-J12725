<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXP.II</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1 class="card-title3">EXP.II</h1>
    <p class="card-title" style="color: #09ff00;text-shadow: -1px -1px 0 #000000, 1px -1px 0 #000000, -1px 1px 0 #000000, 1px 1px 0 #000000">(Documentación)</p>
    <div class="container">
        <div class="card">
            <h1 class="card-title">INSERTAR CÓDIGO</h1>
                       
            <div class="input-group">
             
                <input type="text" id="codeInput" class="code-input" maxlength="4" placeholder="0000" pattern="[01]+" required>
          
            </div>
            
            <div id="errorMessage" class="message error" style="display: none;"></div>
            
            <button id="validateBtn" class="validate-btn">Validar</button>
        </div>
    </div>
        <div class="container">
            <div class="card">
                <h1 class="card-title">DOCUMENTOS LIBERADOS</h1>
                <div class="card-title2 justify-center items-center text-2xl font-bold">
                    <span class="card-title2" id="correctCount">0</span>/<span class="card-title2" id="totalValid">0</span>
                </div>
            </div>
        </div>
    </div>
   
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Código Correcto</h2>
            <div class="qr-code">
                <div id="qrDisplay" class="qr-placeholder">QR generado para: <span id="validCode"></span></div>
            </div>
            <button id="closeModal" class="close-btn">Cerrar</button>
        </div>
    </div>

<script>
    // Códigos válidos predefinidos
    const validCodes = {
        '0110': {
            url: 'https://www.youtube.com/embed/5V2bJHGaq8w',
            title: 'QR_1'
        },
        '0111': {
            url: 'https://www.youtube.com/embed/vdGlBZH-ML0',
            title: 'QR_2'
        },
        '0000': {
            url: 'https://www.youtube.com/embed/p-7MLQvYM30',
            title: 'QR_3'
        }
        // Agrega más códigos, videos y títulos aquí
    };

    // Mapeo de códigos a los índices de los audios que deben reproducirse
    const codeToAudioMap = {
        '0110': [1], // QR_1 reproduce audio1
        '0111': [2], // QR_2 reproduce audio2
        '0000': [3]  // QR_3 reproduce audio3
        // Agrega mapeos para más códigos si es necesario
    };

    // Contadores
    let correctCount = 0;
    let totalValid = Object.keys(validCodes).length;

    // Actualizar el contador en el DOM
    const correctDisplay = document.getElementById('correctCount');
    const totalDisplay = document.getElementById('totalValid');
    correctDisplay.textContent = correctCount;
    totalDisplay.textContent = totalValid;

    // Elementos del DOM
    const modalTitleElement = document.querySelector('.modal-title');
    const codeInput = document.getElementById('codeInput');
    const validateBtn = document.getElementById('validateBtn');
    const qrModal = document.getElementById('qrModal');
    const closeModal = document.getElementById('closeModal');
    const errorMessage = document.getElementById('errorMessage');
    const qrDisplay = document.getElementById('qrDisplay');
    const validCodeSpan = document.getElementById('validCode');

    // --- Crear elementos de audio ---
    const audio1 = new Audio('assets/DigitalRing.mp3');
    audio1.loop = true;
    audio1.volume = 0;

    const audio2 = new Audio('assets/experimento_mezcla.mp3');
    audio2.loop = true;
    audio2.volume = 0;

    const audio3 = new Audio('assets/spaceDistor.mp3');
    audio3.loop = true;
    audio3.volume = 0;

    // Array para manejar los audios fácilmente
    const allAudios = [audio1, audio2, audio3];
    // -------------------------------

    // Función para ajustar el volumen del audio
    function adjustVolume() {
        const maxVolume = 1.0;
        let volume = 0;
        if (totalValid > 0) {
            volume = correctCount / totalValid;
        }
        // Ajustar volumen de todos los audios definidos
        allAudios.forEach(a => {
            a.volume = Math.min(volume, maxVolume);
        });
    }

    // Guardar los códigos ya usados para evitar repetirlos
    const usedCodes = new Set();

    // Validar formato del input en tiempo real
    codeInput.addEventListener('input', function(e) {
        errorMessage.style.display = 'none';
        const value = e.target.value;
        if (/[^01]/.test(value)) {
            e.target.value = value.replace(/[^01]/g, '');
        }
    });

    // Validar el código cuando se presiona el botón
    validateBtn.addEventListener('click', validateCode);

    // También validar al presionar Enter
    codeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            validateCode();
        }
    });

    // Cerrar el modal
    closeModal.addEventListener('click', function() {
        qrModal.classList.remove('active');
        codeInput.value = '';
        // Opcional: Si decides pausar todos al cerrar, descomenta la siguiente línea
        // allAudios.forEach(a => a.pause());
    });

    function validateCode() {
        const code = codeInput.value.trim();

        if (code.length !== 4) {
            showError('Faltan Unidades');
            return;
        }

        if (!/^[01]+$/.test(code)) {
            showError('Solo 0 y 1');
            return;
        }

        if (validCodes.hasOwnProperty(code) && !usedCodes.has(code)) {
            const codeInfo = validCodes[code];
            usedCodes.add(code);

            if (correctCount < totalValid) {
                correctCount++;
                correctDisplay.textContent = correctCount;
            }

            // Ajustar el volumen de todos los audios
            adjustVolume();

            // --- Reproducir audios específicos del código (SIN pausar los demás) ---
            // 1. Obtener los índices de los audios a reproducir para este código
            const audiosToPlayIndices = codeToAudioMap[code] || [];

            // 2. Reproducir los audios correspondientes
            audiosToPlayIndices.forEach(index => {
                // Asegurarse de que el índice sea válido (1, 2 o 3)
                if (index >= 1 && index <= allAudios.length) {
                    // Obtener el audio correspondiente (index - 1 porque el array es 0-based)
                    const audioToPlay = allAudios[index - 1];

                    // Verificar si el audio ya se está reproduciendo
                    // Esta comprobación no es 100% fiable en todos los navegadores, pero es un buen intento
                    // Una forma más robusta es usar una bandera personalizada si es necesario.
                    if (audioToPlay.paused) {
                         // Si está pausado, intentamos reproducirlo desde el inicio
                        audioToPlay.currentTime = 0;
                        audioToPlay.play().catch((e) => {
                            console.log(`No se pudo iniciar la reproducción del audio ${index}:`, e);
                        });
                    } else {
                        // Si ya se está reproduciendo y en loop, no hacemos nada.
                        // Esto mantiene el loop activo sin interrupciones.
                        console.log(`El audio ${index} ya se está reproduciendo.`);
                    }
                }
            });
            // ---------------------------------------------

            // --- Generar QR dinámico ---
            // Nota: Eliminé los espacios extra en baseUrl
            const baseUrl = 'https://exp-ii-j12725.onrender.com/';
            const destinationUrl = `${baseUrl}documentos.html?code=${encodeURIComponent(code)}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(destinationUrl)}&color=09ff00&bgcolor=000000`;
            // --------------------------

            if (modalTitleElement) {
                modalTitleElement.textContent = codeInfo.title;
            }
            validCodeSpan.textContent = code;
            qrDisplay.innerHTML = `<img src="${qrUrl}" alt="Código QR para ${code}">`;
            qrModal.classList.add('active');

        } else {
            if (usedCodes.has(code)) {
                showError('Este código ya fue usado.');
            } else {
                showError('Incorrecto. Vuelva a interpretar');
            }
        }
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        codeInput.style.borderColor = 'var(--error)';
        setTimeout(() => {
            codeInput.style.borderColor = '#dfe6e9';
        }, 2000);
    }
</script>
</body>
</html>
