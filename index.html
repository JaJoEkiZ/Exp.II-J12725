<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXP.II</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1 class="card-title3">EXP.II</h1>
    <p class="card-title" style="color: #09ff00;text-shadow: -1px -1px 0 #000000, 1px -1px 0 #000000, -1px 1px 0 #000000, 1px 1px 0 #000000">(Documentación)</p>
    <div class="container">
        <div class="card">
            <h1 class="card-title">INSERTAR CÓDIGO</h1>
                       
            <div class="input-group">
             
                <input type="text" id="codeInput" class="code-input" maxlength="4" placeholder="0000" pattern="[01]+" required>
          
            </div>
            
            <div id="errorMessage" class="message error" style="display: none;"></div>
            
            <button id="validateBtn" class="validate-btn">Validar</button>
        </div>
    </div>
        <div class="container">
            <div class="card">
                <h1 class="card-title">DOCUMENTOS LIBERADOS</h1>
                <div class="card-title2 justify-center items-center text-2xl font-bold">
                    <span class="card-title2" id="correctCount">0</span>/<span class="card-title2" id="totalValid">0</span>
                </div>
            </div>
        </div>
    </div>
   
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Código Correcto</h2>
            <div class="qr-code">
                <div id="qrDisplay" class="qr-placeholder">QR generado para: <span id="validCode"></span></div>
            </div>
            <button id="closeModal" class="close-btn">Cerrar</button>
        </div>
    </div>

<script>
    // --- Códigos válidos predefinidos ---
    // Ahora cada código tiene un objeto con 'url' y 'title'
    const validCodes = {
        '0110': {
            url: 'https://www.youtube.com/embed/5V2bJHGaq8w',
            title: 'QR_1'
        },
        '0111': {
            url: 'https://www.youtube.com/embed/vdGlBZH-ML0',
            title: 'QR_2'
        },
        '0000': {
            url: 'https://www.youtube.com/embed/p-7MLQvYM30',
            title: 'QR_3'
        },
        '0100': {
            url: 'https://www.youtube.com/embed/68YZ0WKrJlM',
            title: 'QR_4'
        }
        // Agrega más códigos, videos y títulos aquí
    };

    // Mapeo de códigos a los índices de los audios que deben reproducirse
    const codeToAudioMap = {
        '0110': [1], // QR_1 reproduce audio1
        '0111': [2], // QR_2 reproduce audio2
        '0000': [3], // QR_3 reproduce audio3
        '0100': [4]  // QR_4 reproduce audio4
        // Agrega mapeos para más códigos si es necesario
    };

    // Calcular totalValid inmediatamente después de definir validCodes
    let totalValid = Object.keys(validCodes).length; // Debe ser 4 si los 4 códigos están definidos arriba
    // -------------------------------

    // Contadores
    let correctCount = 0;

    // Actualizar el contador en el DOM
    const correctDisplay = document.getElementById('correctCount');
    const totalDisplay = document.getElementById('totalValid');
    correctDisplay.textContent = correctCount;
    totalDisplay.textContent = totalValid;

    // Elementos del DOM
    const modalTitleElement = document.querySelector('.modal-title');
    const codeInput = document.getElementById('codeInput');
    const validateBtn = document.getElementById('validateBtn');
    const qrModal = document.getElementById('qrModal');
    const closeModal = document.getElementById('closeModal');
    const errorMessage = document.getElementById('errorMessage');
    const qrDisplay = document.getElementById('qrDisplay');
    const validCodeSpan = document.getElementById('validCode');

    // --- Crear elementos de audio ---
    const audio1 = new Audio('assets/DigitalRing.mp3');
    const audio2 = new Audio('assets/experimento_mezcla.mp3');
    const audio3 = new Audio('assets/spaceDistor.mp3');
    const audio4 = new Audio('assets/4.mp3');

    // Array para manejar los audios fácilmente
    const allAudios = [audio1, audio2, audio3, audio4];

    // Configurar cada audio para asegurar loop y volumen inicial
    allAudios.forEach((audio, index) => {
        // Listener para cuando el audio puede reproducirse completamente
        const setupAudio = () => {
            audio.loop = true; // Forzar loop
            audio.volume = 0;  // Volumen inicial
            console.log(`Audio ${index + 1} listo: loop=${audio.loop}, volume=${audio.volume}`);
            // Eliminar el listener para evitar ejecuciones múltiples
            audio.removeEventListener('canplaythrough', setupAudio);
        };

        audio.addEventListener('canplaythrough', setupAudio);
        // Iniciar la carga del audio
        audio.load();
    });
    // -------------------------------

    // Función para ajustar el volumen del audio
    function adjustVolume() {
        const maxVolume = 1.0;
        let volume = 0;
        if (totalValid > 0) {
            volume = correctCount / totalValid;
        }
        // Ajustar volumen de todos los audios definidos
        allAudios.forEach(a => {
            // Asegurar loop esté activo al ajustar volumen
            a.loop = true;
            a.volume = Math.min(volume, maxVolume);
        });
        console.log(`Volumen ajustado a ${(volume * 100).toFixed(1)}%`);
    }

    // Guardar los códigos ya usados para evitar repetirlos
    const usedCodes = new Set();

    // Validar formato del input en tiempo real
    codeInput.addEventListener('input', function(e) {
        errorMessage.style.display = 'none';
        const value = e.target.value;
        if (/[^01]/.test(value)) {
            e.target.value = value.replace(/[^01]/g, '');
        }
    });

    // Validar el código cuando se presiona el botón
    validateBtn.addEventListener('click', validateCode);

    // También validar al presionar Enter
    codeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            validateCode();
        }
    });

    // Cerrar el modal
    closeModal.addEventListener('click', function() {
        qrModal.classList.remove('active');
        codeInput.value = '';
        // Opcional: Si decides pausar todos al cerrar, descomenta la siguiente línea
        // allAudios.forEach(a => a.pause());
    });

    function validateCode() {
        const code = codeInput.value.trim();

        if (code.length !== 4) {
            showError('Faltan Unidades');
            return;
        }

        if (!/^[01]+$/.test(code)) {
            showError('Solo 0 y 1');
            return;
        }

        if (validCodes.hasOwnProperty(code) && !usedCodes.has(code)) {
            const codeInfo = validCodes[code];
            usedCodes.add(code);

            if (correctCount < totalValid) {
                correctCount++;
                correctDisplay.textContent = correctCount;
            }

            // Ajustar el volumen de todos los audios
            adjustVolume();

            // --- Reproducir audios específicos del código (SIN pausar los demás) ---
            const audiosToPlayIndices = codeToAudioMap[code] || [];
            console.log(`Intentando reproducir audios para código ${code}:`, audiosToPlayIndices);

            audiosToPlayIndices.forEach(index => {
                if (index >= 1 && index <= allAudios.length) {
                    const audioToPlay = allAudios[index - 1];

                    // Forzar loop y reiniciar justo antes de reproducir
                    audioToPlay.loop = true;
                    audioToPlay.currentTime = 0;

                    audioToPlay.play().then(() => {
                        console.log(`Audio ${index} iniciado correctamente para código ${code}.`);
                    }).catch((e) => {
                        console.error(`Error al reproducir audio ${index} para código ${code}:`, e);
                    });
                }
            });
            // ---------------------------------------------

            // --- Generar QR dinámico ---
            // Calcular baseUrl automáticamente para mayor robustez
            const baseUrl = window.location.origin + '/';
            console.log("Base URL utilizada para QR:", baseUrl);

            const destinationUrl = `${baseUrl}documentos.html?code=${encodeURIComponent(code)}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(destinationUrl)}&color=09ff00&bgcolor=000000`;
            // --------------------------

            if (modalTitleElement) {
                modalTitleElement.textContent = codeInfo.title;
            }
            validCodeSpan.textContent = code;
            qrDisplay.innerHTML = `<img src="${qrUrl}" alt="Código QR para ${code}">`;
            qrModal.classList.add('active');

        } else {
            if (usedCodes.has(code)) {
                showError('Este código ya fue usado.');
            } else {
                showError('Incorrecto. Vuelva a interpretar');
            }
        }
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        codeInput.style.borderColor = 'var(--error)';
        setTimeout(() => {
            codeInput.style.borderColor = '#dfe6e9';
        }, 2000);
    }
</script>
</body>
</html>
