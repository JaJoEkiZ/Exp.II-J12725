<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXP.II</title>
    <link rel="icon" type="image/png" href="images/favicon.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1 class="card-title3">EXP.II</h1>
    <p class="card-title" style="color: #09ff00;text-shadow: -1px -1px 0 #000000, 1px -1px 0 #000000, -1px 1px 0 #000000, 1px 1px 0 #000000">(Documentación)</p>
    <div class="container">
        <div class="card">
            <h1 class="card-title">INSERTAR CÓDIGO</h1>
                       
            <div class="input-group">
             
                <input type="text" id="codeInput" class="code-input" maxlength="4" placeholder="0000" pattern="[01]+" required>
          
            </div>
            
            <div id="errorMessage" class="message error" style="display: none;"></div>
            
            <button id="validateBtn" class="validate-btn">Validar</button>
        </div>
    </div>
        <div class="container">
            <div class="card">
                <h1 class="card-title">DOCUMENTOS LIBERADOS</h1>
                <div class="card-title2 justify-center items-center text-2xl font-bold">
                    <span class="card-title2" id="correctCount">0</span>/<span class="card-title2" id="totalValid">0</span>
                </div>
            </div>
        </div>
    </div>
   
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Código Correcto</h2>
            <div class="qr-code">
                <div id="qrDisplay" class="qr-placeholder">QR generado para: <span id="validCode"></span></div>
            </div>
            <button id="closeModal" class="close-btn">Cerrar</button>
        </div>
    </div>

<script>
    // Códigos válidos predefinidos
    // Ahora cada código tiene un objeto con 'url' y 'title'
    const validCodes = {
        '0110': {
            url: 'https://www.youtube.com/embed/5V2bJHGaq8w',
            title: 'QR_1'
        },
        '0111': {
            url: 'https://www.youtube.com/embed/vdGlBZH-ML0',
            title: 'QR_2'
        }/*,
        '1100': {
            url: 'https://www.youtube.com/embed/',
            title: 'QR_3'
        }*/
        // Agrega más códigos, videos y títulos aquí
    };

    // Contadores
    let correctCount = 0;
    let totalValid = Object.keys(validCodes).length;

    // Actualizar el contador en el DOM
    const correctDisplay = document.getElementById('correctCount');
    const totalDisplay = document.getElementById('totalValid');

    // Mostrar el contador inicial
    correctDisplay.textContent = correctCount;
    totalDisplay.textContent = totalValid;

    // Elementos del DOM
    // Asumo que tienes un elemento para el título del modal, por ejemplo, con id 'modalTitle'
    // Si no lo tienes, crea uno o usa el existente (como .modal-title)
    const modalTitleElement = document.querySelector('.modal-title'); // O usa getElementById si le pones un ID
    const codeInput = document.getElementById('codeInput');
    const validateBtn = document.getElementById('validateBtn');
    const qrModal = document.getElementById('qrModal');
    const closeModal = document.getElementById('closeModal');
    const errorMessage = document.getElementById('errorMessage');
    const qrDisplay = document.getElementById('qrDisplay');
    const validCodeSpan = document.getElementById('validCode');

    // Crear el elemento de audio
    const audio = new Audio('assets/experimento_mezcla.mp3');
    audio.loop = true;
    audio.volume = 0;
    
    const audio2 = new Audio('assets/DigitalRing.mp3');
    audio2.loop = true;
    audio2.volume = 0;

    // Función para ajustar el volumen del audio
    function adjustVolume() {
        const maxVolume = 1.0;
        if (totalValid > 0) {
            const volume = correctCount / totalValid;
            audio.volume = Math.min(volume, maxVolume);
            audio2.volume = Math.min(volume, maxVolume);
        } else {
            audio.volume = 0;
            audio2.volume = 0;
        }
    }
 
 
    


    // Guardar los códigos ya usados para evitar repetirlos
    const usedCodes = new Set();

    // Validar formato del input en tiempo real
    codeInput.addEventListener('input', function(e) {
        errorMessage.style.display = 'none';
        const value = e.target.value;
        if (/[^01]/.test(value)) {
            e.target.value = value.replace(/[^01]/g, '');
        }
    });

    // Validar el código cuando se presiona el botón
    validateBtn.addEventListener('click', validateCode);

    // También validar al presionar Enter
    codeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            validateCode();
        }
    });

    // Cerrar el modal
    closeModal.addEventListener('click', function() {
        qrModal.classList.remove('active');
        codeInput.value = '';
    });

    function validateCode() {
        const code = codeInput.value.trim();

        if (code.length !== 4) {
            showError('Faltan Unidades');
            return;
        }

        if (!/^[01]+$/.test(code)) {
            showError('Solo 0 y 1');
            return;
        }

        // Verificar si el código es válido y no ha sido usado antes
        if (validCodes.hasOwnProperty(code) && !usedCodes.has(code)) {
            // Obtener la información del código
            const codeInfo = validCodes[code];

            // Añadir el código a los usados
            usedCodes.add(code);

            // Incrementar el contador de aciertos
            if (correctCount < totalValid) {
                correctCount++;
                correctDisplay.textContent = correctCount;
            }

            // Ajustar el volumen del audio
            adjustVolume();

            // Reproducir el audio
            audio.play().catch(() => {
                console.log("No se pudo reproducir el audio");
            });
            audio2.play().catch(() => {
                console.log("No se pudo reproducir el audio");
            });

            // --- Generar QR dinámico ---
            // Construimos la URL de destino usando la URL base del sitio desplegado
            const baseUrl = 'https://exp-ii-j12725.onrender.com/';
            const destinationUrl = `${baseUrl}documentos.html?code=${encodeURIComponent(code)}`;
            // Generamos la URL del QR usando la API
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(destinationUrl)}&color=09ff00&bgcolor=000000`;

            // Mostrar modal con éxito, el título personalizado y el QR generado
            // Actualiza el título del modal
            if (modalTitleElement) {
                modalTitleElement.textContent = codeInfo.title; // Usar el título del código
            }
            validCodeSpan.textContent = code;
            // Limpiar el contenido anterior y mostrar la nueva imagen
            qrDisplay.innerHTML = `<img src="${qrUrl}" alt="Código QR para ${code}">`;
            qrModal.classList.add('active');

        } else {
            if (usedCodes.has(code)) {
                showError('Este código ya fue usado.');
            } else {
                showError('Incorrecto. Vuelva a interpretar');
            }
        }
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        codeInput.style.borderColor = 'var(--error)';
        setTimeout(() => {
            codeInput.style.borderColor = '#dfe6e9';
        }, 2000);
    }
</script>
</body>
</html>
